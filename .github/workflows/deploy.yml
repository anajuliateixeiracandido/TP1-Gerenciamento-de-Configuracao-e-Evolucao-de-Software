name: Deploy Pipeline

on:
  workflow_run:
    workflows: ["Build Pipeline"] 
    types: [completed]

jobs:
  deploy:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      (github.event.workflow_run.head_branch == 'main' || github.event.workflow_run.head_branch == 'master')

    runs-on: ubuntu-latest

    steps:
      - name: Trigger Render Deploy Hook
        run: curl -X POST "$RENDER_DEPLOY_HOOK"
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}

      - name: Health check (wait app be ready)
        run: |
          echo "Checking health..."
          for i in {1..30}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" https://tp1-gerenciamento-de-configuracao-e.onrender.com/health || true)
            if [ "$code" = "200" ]; then
              echo "App is healthy!"
              exit 0
            fi
            echo "Not ready yet (status=$code). retrying..."
            sleep 5
          done
          echo "Health check failed!"
          exit 1
